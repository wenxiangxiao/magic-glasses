<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ•¶ï¸ ç¥å¥‡çœ¼é¡ - é¡è‰²ç–Šç–Šæ¨‚</title>
    <style>
        :root {
            --red: #FF6B6B;
            --yellow: #FFE066;
            --blue: #74C0FC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans TC', sans-serif;
            background: linear-gradient(180deg, #FFF5E6 0%, #FFE4CC 100%);
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
            height: 100dvh;
        }

        .hidden { display: none !important; }

        /* === å¤§è±¡è§’è‰² === */
        .mammoth-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
        }

        .mammoth {
            font-size: 4rem;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
            animation: mammothIdle 3s ease-in-out infinite;
            transition: all 0.3s;
        }

        .mammoth-small {
            font-size: 2.5rem;
        }

        .mammoth-mini {
            font-size: 1.8rem;
        }

        /* Idle å‹•ç•« - è¼•å¾®æ™ƒå‹• */
        @keyframes mammothIdle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-3px) rotate(-2deg); }
            75% { transform: translateY(-3px) rotate(2deg); }
        }

        /* é–‹å¿ƒè·³èˆå‹•ç•« */
        @keyframes mammothHappy {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            10% { transform: translateY(-15px) rotate(-10deg) scale(1.1); }
            20% { transform: translateY(0) rotate(10deg) scale(1); }
            30% { transform: translateY(-15px) rotate(-10deg) scale(1.1); }
            40% { transform: translateY(0) rotate(10deg) scale(1); }
            50% { transform: translateY(-15px) rotate(-10deg) scale(1.1); }
            60% { transform: translateY(0) rotate(10deg) scale(1); }
            70% { transform: translateY(-15px) rotate(0deg) scale(1.15); }
            85% { transform: translateY(-8px) rotate(0deg) scale(1.1); }
        }

        .mammoth.happy {
            animation: mammothHappy 1.2s ease-out;
        }

        /* æ–é ­é¼“å‹µå‹•ç•« */
        @keyframes mammothSad {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            15% { transform: translateX(-8px) rotate(-5deg); }
            30% { transform: translateX(8px) rotate(5deg); }
            45% { transform: translateX(-8px) rotate(-5deg); }
            60% { transform: translateX(8px) rotate(5deg); }
            75% { transform: translateX(-4px) rotate(-2deg); }
            90% { transform: translateX(4px) rotate(2deg); }
        }

        .mammoth.sad {
            animation: mammothSad 0.8s ease-out;
        }

        /* ç­‰å¾…æ€è€ƒå‹•ç•« */
        @keyframes mammothThink {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.03); }
        }

        .mammoth.thinking {
            animation: mammothThink 1.5s ease-in-out infinite;
        }

        /* å¤§è±¡å°è©±æ³¡æ³¡ */
        .mammoth-speech {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .mammoth-speech::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid white;
        }

        .mammoth-speech.show {
            opacity: 1;
        }

        /* === é€šç”¨ç•«é¢ === */
        .screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FFF5E6 0%, #FFE4CC 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 200;
            overflow-y: auto;
        }

        .screen-title { font-size: 2rem; color: #5D4037; margin-bottom: 8px; }
        .screen-sub { font-size: 1rem; color: #8D6E63; margin-bottom: 24px; text-align: center; }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 280px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:active { transform: scale(0.96); }
        .btn-green { background: linear-gradient(135deg, #81C784, #4CAF50); color: white; }
        .btn-orange { background: linear-gradient(135deg, #FFB74D, #FF9800); color: white; }
        .btn-blue { background: linear-gradient(135deg, #64B5F6, #2196F3); color: white; }
        .btn-red { background: linear-gradient(135deg, #E57373, #F44336); color: white; }
        .btn-purple { background: linear-gradient(135deg, #BA68C8, #9C27B0); color: white; }
        .btn-gray { background: #E0E0E0; color: #666; }
        .btn small { display: block; font-size: 0.8rem; font-weight: 400; opacity: 0.9; margin-top: 4px; }

        /* === éŠæˆ²é ­éƒ¨ === */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            background: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #5D4037;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .badge.highlight {
            background: linear-gradient(135deg, #FFD54F, #FFB300);
            color: #5D4037;
        }

        /* é€£çºŒç­”å°æ˜Ÿæ˜Ÿ */
        .streak-stars {
            display: flex;
            gap: 2px;
        }

        .streak-stars span {
            font-size: 1.2rem;
            opacity: 0.2;
            transition: all 0.3s;
        }

        .streak-stars span.active {
            opacity: 1;
            animation: starPop 0.3s ease;
        }

        @keyframes starPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

        /* è¨ˆæ™‚å™¨ */
        .timer {
            font-size: 1.1rem;
            font-weight: 700;
            color: #5D4037;
            min-width: 50px;
            text-align: center;
        }

        .timer.warning { color: #FF9800; animation: pulse 0.5s infinite; }
        .timer.danger { color: #F44336; animation: pulse 0.3s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* === VS é ­éƒ¨ï¼ˆé›™äººï¼‰ === */
        .vs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 16px;
            border-radius: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .player-info {
            text-align: center;
            min-width: 80px;
        }

        .player-info.me .score { color: #4CAF50; }
        .player-info.opp .score { color: #FF9800; }
        .player-info .name { font-size: 0.8rem; color: #8D6E63; }
        .player-info .score { font-size: 1.4rem; font-weight: 700; }
        .player-info .status { font-size: 0.7rem; color: #4CAF50; }

        .vs-text { font-size: 1rem; color: #BDBDBD; font-weight: 700; }

        /* === éŠæˆ²å€ === */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
        }

        /* é—œå¡é€²åº¦æ¢ */
        .level-progress {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-progress .label {
            font-size: 0.8rem;
            color: #8D6E63;
            font-weight: 600;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #81C784, #4CAF50);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* å¡ç‰‡å€åŸŸ */
        .cards-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: stretch;
        }

        .card-wrapper {
            flex: 1;
            max-width: 155px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #8D6E63;
            margin-bottom: 4px;
        }

        .big-card {
            width: 100%;
            aspect-ratio: 1;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .big-card.target { border: 4px solid #FFD54F; }
        .big-card.answer { border: 4px dashed #BDBDBD; transition: all 0.3s; }
        .big-card.answer.has-content { border-style: solid; border-color: #81C784; }
        .big-card.answer.drag-over { border-color: #4CAF50; transform: scale(1.02); }

        .card-fill {
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border-radius: 12px;
            background: #F5F5F5;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        /* ç‰¹æ®Šå¡ç‰‡åˆ†å‰²æ•ˆæœ */
        .card-fill.split {
            background: none !important;
        }

        .card-fill.split::before,
        .card-fill.split::after {
            content: '';
            position: absolute;
            top: 0;
            height: 100%;
            width: 50%;
            border-radius: 12px;
        }

        .card-fill.split::before { left: 0; border-radius: 12px 0 0 12px; }
        .card-fill.split::after { right: 0; border-radius: 0 12px 12px 0; }

        /* èŠ±ç´‹å±¤ */
        .pattern-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .pattern-layer.active { opacity: 1; }
        .pattern-layer.dots { background-image: radial-gradient(circle, rgba(255,255,255,0.8) 4px, transparent 4px); background-size: 14px 14px; }
        .pattern-layer.stripes { background: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(255,255,255,0.6) 4px, rgba(255,255,255,0.6) 8px); }
        .pattern-layer.grid { background-image: linear-gradient(rgba(255,255,255,0.6) 2px, transparent 2px), linear-gradient(90deg, rgba(255,255,255,0.6) 2px, transparent 2px); background-size: 14px 14px; }
        .pattern-layer.zigzag { background: repeating-linear-gradient(135deg, transparent, transparent 3px, rgba(255,255,255,0.5) 3px, rgba(255,255,255,0.5) 6px), repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(255,255,255,0.5) 3px, rgba(255,255,255,0.5) 6px); }
        .pattern-layer.circles { background-image: radial-gradient(circle, transparent 6px, rgba(255,255,255,0.5) 6px, rgba(255,255,255,0.5) 8px, transparent 8px); background-size: 20px 20px; }

        .drop-hint {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #BDBDBD;
            font-size: 0.85rem;
            text-align: center;
        }

        .big-card.has-content .drop-hint { opacity: 0; }

        /* æç¤ºè¨Šæ¯ */
        .hint-message {
            text-align: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            font-size: 0.9rem;
            color: #5D4037;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* é¡è‰²æç¤ºåˆ— */
        .color-hints {
            display: flex;
            justify-content: center;
            gap: 8px;
            font-size: 0.7rem;
            color: #8D6E63;
            flex-wrap: wrap;
        }

        .hint-item { display: flex; align-items: center; gap: 2px; }
        .hint-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* === é€æ˜ç‰‡å€ === */
        .filters-area {
            background: white;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .filter-section { margin-bottom: 10px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-title { font-size: 0.75rem; color: #8D6E63; font-weight: 600; margin-bottom: 6px; text-align: center; }

        .filter-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .draggable-chip {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            cursor: grab;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            position: relative;
            flex-shrink: 0;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .draggable-chip.dragging { opacity: 0.5; transform: scale(0.9); }
        .draggable-chip.locked { opacity: 0.4; cursor: not-allowed; }

        .draggable-chip.used::after {
            content: 'âœ“';
            position: absolute;
            top: -4px; right: -4px;
            width: 18px; height: 18px;
            background: #4CAF50;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .draggable-chip.color-red { background: linear-gradient(145deg, #FF8A80, #FF5252); }
        .draggable-chip.color-yellow { background: linear-gradient(145deg, #FFEE58, #FFD600); }
        .draggable-chip.color-blue { background: linear-gradient(145deg, #64B5F6, #42A5F5); }
        .draggable-chip.color-black { background: linear-gradient(145deg, #616161, #424242); }
        .draggable-chip.color-white { background: linear-gradient(145deg, #FFFFFF, #EEEEEE); border: 2px solid #BDBDBD; }

        .draggable-chip.pattern-chip { background: #EEE; overflow: hidden; }
        .chip-pattern { width: 100%; height: 100%; border-radius: 12px; }
        .chip-pattern.dots { background: #CCC; background-image: radial-gradient(circle, #777 3px, transparent 3px); background-size: 10px 10px; }
        .chip-pattern.stripes { background: repeating-linear-gradient(45deg, #CCC, #CCC 3px, #999 3px, #999 6px); }
        .chip-pattern.grid { background: #CCC; background-image: linear-gradient(#888 2px, transparent 2px), linear-gradient(90deg, #888 2px, transparent 2px); background-size: 10px 10px; }
        .chip-pattern.zigzag { background: #CCC; background-image: repeating-linear-gradient(135deg, #888 0px, #888 1.5px, transparent 1.5px, transparent 4px), repeating-linear-gradient(45deg, #888 0px, #888 1.5px, transparent 1.5px, transparent 4px); }
        .chip-pattern.circles { background: #CCC; background-image: radial-gradient(circle, transparent 4px, #888 4px, #888 5px, transparent 5px); background-size: 14px 14px; }

        .drag-ghost {
            position: fixed;
            width: 70px; height: 70px;
            border-radius: 14px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* === åº•éƒ¨æŒ‰éˆ• === */
        .actions {
            display: flex;
            gap: 10px;
            padding-top: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .action-btn:active { transform: scale(0.96); }
        .btn-clear { background: #F5F5F5; color: #757575; }
        .btn-check { background: linear-gradient(135deg, #66BB6A, #43A047); color: white; }
        .btn-check:disabled { background: #E0E0E0; color: #9E9E9E; }

        /* === å½ˆçª— === */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 300;
        }

        .modal.show { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: white;
            padding: 28px 36px;
            border-radius: 24px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 300px;
            width: 90%;
        }

        .modal.show .modal-content { transform: scale(1); }

        .modal-emoji { font-size: 4rem; line-height: 1; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #333; margin-top: 8px; }
        .modal-sub { font-size: 1rem; color: #666; margin-top: 4px; }
        .modal-btn { margin-top: 20px; width: 100%; }

        /* æ…¶ç¥å‹•ç•« */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 400;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* æˆ¿é–“ç¢¼è¼¸å…¥ */
        .room-code-input {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .room-code-input input {
            width: 56px;
            height: 56px;
            font-size: 1.6rem;
            text-align: center;
            border: 3px solid #DDD;
            border-radius: 12px;
            font-weight: 700;
            color: #5D4037;
        }

        .room-code-input input:focus {
            outline: none;
            border-color: #FF9800;
        }

        .room-code-display {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 8px;
            color: #5D4037;
            background: white;
            padding: 16px 28px;
            border-radius: 16px;
            margin: 16px 0;
        }

        .waiting-text {
            color: #8D6E63;
            font-size: 1rem;
            animation: pulse 1.5s infinite;
        }

        /* === æ•™å­¸æ¨¡å¼æ¨£å¼ === */
        .tutorial-content {
            width: 100%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px 0;
        }

        .tutorial-section {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .tutorial-section h3 {
            font-size: 1.1rem;
            color: #5D4037;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-formula {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: #FFF9F0;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .color-formula:last-child { margin-bottom: 0; }

        .formula-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .formula-symbol {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8D6E63;
        }

        .formula-label {
            font-size: 0.8rem;
            color: #666;
            margin-left: 4px;
        }

        /* äº’å‹•ç·´ç¿’å€ */
        .practice-area {
            background: #FFF9F0;
            border-radius: 12px;
            padding: 16px;
        }

        .practice-dropzone {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            background: white;
            border: 3px dashed #BDBDBD;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .practice-dropzone.has-color {
            border-style: solid;
            border-color: #81C784;
        }

        .practice-dropzone.drag-over {
            border-color: #4CAF50;
            transform: scale(1.02);
        }

        .practice-dropzone-fill {
            position: absolute;
            inset: 8px;
            border-radius: 12px;
            background: #F5F5F5;
            transition: background 0.3s;
        }

        .practice-result {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: #5D4037;
            min-height: 32px;
        }

        .practice-chips {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
        }

        .practice-chip {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .practice-chip:active { transform: scale(0.95); }
        .practice-chip.selected { 
            box-shadow: 0 0 0 3px #4CAF50, 0 2px 6px rgba(0,0,0,0.15);
            transform: scale(1.05);
        }
        
        .practice-pattern-layer {
            position: absolute;
            inset: 0;
            border-radius: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .practice-pattern-layer.active { opacity: 1; }
        .practice-pattern-layer.dots { background-image: radial-gradient(circle, rgba(255,255,255,0.8) 4px, transparent 4px); background-size: 14px 14px; }
        .practice-pattern-layer.stripes { background: repeating-linear-gradient(45deg, transparent, transparent 6px, rgba(255,255,255,0.6) 6px, rgba(255,255,255,0.6) 12px); }
        .practice-pattern-layer.grid { background-image: linear-gradient(rgba(255,255,255,0.6) 2px, transparent 2px), linear-gradient(90deg, rgba(255,255,255,0.6) 2px, transparent 2px); background-size: 14px 14px; }

        .practice-btn-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .practice-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* èŠ±ç´‹å±•ç¤º */
        .pattern-showcase {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .pattern-item {
            text-align: center;
        }

        .pattern-demo {
            width: 60px;
            height: 60px;
            margin: 0 auto 6px;
            border-radius: 12px;
            background: #BDBDBD;
        }

        .pattern-demo.dots { background-image: radial-gradient(circle, #777 3px, transparent 3px); background-size: 10px 10px; }
        .pattern-demo.stripes { background: repeating-linear-gradient(45deg, #BDBDBD, #BDBDBD 3px, #888 3px, #888 6px); }
        .pattern-demo.grid { background-image: linear-gradient(#777 2px, transparent 2px), linear-gradient(90deg, #777 2px, transparent 2px); background-size: 10px 10px; }
        .pattern-demo.zigzag { background-image: repeating-linear-gradient(135deg, #777 0px, #777 2px, transparent 2px, transparent 4px), repeating-linear-gradient(45deg, #777 0px, #777 2px, transparent 2px, transparent 4px); }
        .pattern-demo.circles { background-image: radial-gradient(circle, transparent 4px, #777 4px, #777 5px, transparent 5px); background-size: 12px 12px; }

        .pattern-name {
            font-size: 0.75rem;
            color: #8D6E63;
        }

        /* éŠæˆ²å…§å¤§è±¡ä½ç½® */
        .game-mammoth {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 100;
        }

        @media (max-height: 700px) {
            .game-mammoth {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ========== é–‹å§‹ç•«é¢ ========== -->
    <div class="screen" id="startScreen">
        <div class="mammoth-container">
            <div class="mammoth" id="startMammoth">ğŸ¦£</div>
            <div class="mammoth-speech" id="startSpeech">å—¨ï¼ä¸€èµ·ç©é¡è‰²éŠæˆ²å§ï¼</div>
        </div>
        <div class="screen-title">ğŸ¨ ç¥å¥‡è¡£æ«¥</div>
        <div class="screen-sub">ç”¨é€æ˜ç‰‡ç–Šå‡ºæ­£ç¢ºçš„é¡è‰²å’ŒèŠ±ç´‹ï¼</div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="showModeSelect()">ğŸ® å–®äººé—˜é—œ<small>è¶Šä¾†è¶Šé›£çš„æŒ‘æˆ°</small></button>
            <button class="btn btn-orange" onclick="showMultiMenu()">ğŸ‘¥ é›™äººå°æˆ°<small>å’Œæœ‹å‹æ¯”è³½ï¼</small></button>
            <button class="btn btn-blue" onclick="showFreePlay()">ğŸ¯ è‡ªç”±ç·´ç¿’<small>é¸æ“‡é›£åº¦è‡ªç”±ç©</small></button>
            <button class="btn btn-purple" onclick="showTutorial()">ğŸ“š æ•™å­¸æ¨¡å¼<small>å­¸ç¿’é¡è‰²æ··åˆ</small></button>
        </div>
    </div>

    <!-- ========== æ•™å­¸æ¨¡å¼ ========== -->
    <div class="screen hidden" id="tutorialScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small" id="tutorialMammoth">ğŸ¦£</div>
            <div class="mammoth-speech" id="tutorialSpeech">è®“æˆ‘æ•™ä½ é¡è‰²æ€éº¼æ··åˆï¼</div>
        </div>
        <div class="screen-title">ğŸ“š æ•™å­¸æ¨¡å¼</div>
        
        <div class="tutorial-content">
            <!-- é¡è‰²æ··åˆæ•™å­¸ -->
            <div class="tutorial-section">
                <h3>ğŸ¨ é¡è‰²æ··åˆé­”æ³•</h3>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #FF5252"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #42A5F5"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #9C27B0"></div>
                    <span class="formula-label">ç´«è‰²</span>
                </div>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #FF5252"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #FFD600"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #FF9800"></div>
                    <span class="formula-label">æ©™è‰²</span>
                </div>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #FFD600"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #42A5F5"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #66BB6A"></div>
                    <span class="formula-label">ç¶ è‰²</span>
                </div>
                <h3 style="margin-top: 16px;">âš« æ·±æ·ºè®ŠåŒ–</h3>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #FF5252"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #424242"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #B71C1C"></div>
                    <span class="formula-label">æ·±ç´…</span>
                </div>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #FF5252"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #FAFAFA; border: 1px solid #DDD;"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #FFCDD2"></div>
                    <span class="formula-label">ç²‰ç´…</span>
                </div>
                <div class="color-formula">
                    <div class="formula-dot" style="background: #42A5F5"></div>
                    <span class="formula-symbol">+</span>
                    <div class="formula-dot" style="background: #424242"></div>
                    <span class="formula-symbol">=</span>
                    <div class="formula-dot" style="background: #1A237E"></div>
                    <span class="formula-label">æ·±è—</span>
                </div>
            </div>

            <!-- äº’å‹•ç·´ç¿’ -->
            <div class="tutorial-section">
                <h3>ğŸ§ª è©¦è©¦çœ‹ï¼</h3>
                <div class="practice-area">
                    <div class="practice-dropzone" id="practiceDropzone">
                        <div class="practice-dropzone-fill" id="practiceDropzoneFill"></div>
                        <div class="practice-pattern-layer" id="practicePatternLayer"></div>
                        <span style="color:#BDBDBD; position:relative; z-index:1;" id="practiceHint">é»é¸é¡è‰²å’ŒèŠ±ç´‹</span>
                    </div>
                    <div class="practice-result" id="practiceResult">é¸æ“‡é¡è‰²çœ‹çœ‹æœƒè®Šä»€éº¼è‰²ï¼</div>
                    <div class="practice-chips" id="practiceChips">
                        <div class="practice-chip" style="background: linear-gradient(145deg, #FF8A80, #FF5252)" data-color="red"></div>
                        <div class="practice-chip" style="background: linear-gradient(145deg, #FFEE58, #FFD600)" data-color="yellow"></div>
                        <div class="practice-chip" style="background: linear-gradient(145deg, #64B5F6, #42A5F5)" data-color="blue"></div>
                        <div class="practice-chip" style="background: linear-gradient(145deg, #616161, #424242)" data-color="black"></div>
                        <div class="practice-chip" style="background: linear-gradient(145deg, #FFF, #EEE); border: 1px solid #DDD;" data-color="white"></div>
                    </div>
                    <div class="practice-chips" id="practicePatterns" style="margin-top: 8px;">
                        <div class="practice-chip practice-pattern-chip" data-pattern="dots"><div class="chip-pattern dots" style="width:100%;height:100%;border-radius:12px;pointer-events:none;"></div></div>
                        <div class="practice-chip practice-pattern-chip" data-pattern="stripes"><div class="chip-pattern stripes" style="width:100%;height:100%;border-radius:12px;pointer-events:none;"></div></div>
                        <div class="practice-chip practice-pattern-chip" data-pattern="grid"><div class="chip-pattern grid" style="width:100%;height:100%;border-radius:12px;pointer-events:none;"></div></div>
                    </div>
                    <div class="practice-btn-row">
                        <button class="practice-btn btn-gray" onclick="clearPractice()">ğŸ”„ æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <!-- èŠ±ç´‹ä»‹ç´¹ -->
            <div class="tutorial-section">
                <h3>âœ¨ èŠ±ç´‹åœ–æ¡ˆ</h3>
                <p style="font-size: 0.85rem; color: #8D6E63; margin-bottom: 12px;">èŠ±ç´‹æœƒç–ŠåŠ åœ¨é¡è‰²ä¸Šé¢å–”ï¼</p>
                <div class="pattern-showcase">
                    <div class="pattern-item">
                        <div class="pattern-demo dots"></div>
                        <div class="pattern-name">é»é»</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-demo stripes"></div>
                        <div class="pattern-name">æ–œæ¢ç´‹</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-demo grid"></div>
                        <div class="pattern-name">æ ¼å­</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-demo zigzag"></div>
                        <div class="pattern-name">é‹¸é½’</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-demo circles"></div>
                        <div class="pattern-name">åœ“åœˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-gray" style="margin-top:16px; max-width:280px; width:100%;" onclick="showScreen('startScreen')">â† è¿”å›ä¸»é¸å–®</button>
    </div>

    <!-- ========== å–®äººé›£åº¦é¸æ“‡ ========== -->
    <div class="screen hidden" id="modeScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small">ğŸ¦£</div>
        </div>
        <div class="screen-title">ğŸ® é—˜é—œæ¨¡å¼</div>
        <div class="screen-sub">å¾ç¬¬1é—œé–‹å§‹ï¼Œçœ‹ä½ èƒ½é—˜åˆ°ç¬¬å¹¾é—œï¼</div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="startAdventure()">ğŸš€ é–‹å§‹é—˜é—œ</button>
            <button class="btn btn-gray" onclick="showScreen('startScreen')">â† è¿”å›</button>
        </div>
    </div>

    <!-- ========== è‡ªç”±ç·´ç¿’é›£åº¦é¸æ“‡ ========== -->
    <div class="screen hidden" id="freePlayScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small">ğŸ¦£</div>
        </div>
        <div class="screen-title">ğŸ¯ è‡ªç”±ç·´ç¿’</div>
        <div class="screen-sub">é¸æ“‡é›£åº¦é–‹å§‹ç·´ç¿’</div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="startFreePlay('easy')">ğŸŒ± ç°¡å–®<small>å–®è‰² + åŸºæœ¬èŠ±ç´‹</small></button>
            <button class="btn btn-orange" onclick="startFreePlay('medium')">ğŸŒŸ æ™®é€š<small>é›™è‰²æ··åˆ</small></button>
            <button class="btn btn-red" onclick="startFreePlay('hard')">ğŸ”¥ å›°é›£<small>ä¸‰è‰²æ··åˆ + æ›´å¤šèŠ±ç´‹</small></button>
            <button class="btn btn-gray" onclick="showScreen('startScreen')">â† è¿”å›</button>
        </div>
    </div>

    <!-- ========== é›™äººé¸å–® ========== -->
    <div class="screen hidden" id="multiScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small">ğŸ¦£</div>
        </div>
        <div class="screen-title">ğŸ‘¥ é›™äººå°æˆ°</div>
        <div class="screen-sub">é¸æ“‡å°æˆ°æ¨¡å¼é–‹å§‹éŠæˆ²ï¼</div>
        <div style="margin: 16px 0; text-align: center;">
            <div style="margin-bottom: 12px;">
                <label style="color: #5D4037; font-weight: 600;">å°æˆ°æ¨¡å¼ï¼š</label>
                <select id="battleModeSelect" style="padding: 8px 16px; font-size: 1rem; border-radius: 8px; border: 2px solid #FFCC80;">
                    <option value="race">âš¡ æ¶ç­”æ¨¡å¼</option>
                    <option value="solo">ğŸ¯ å„è‡ªç­”é¡Œ</option>
                </select>
            </div>
            <div style="font-size: 0.85rem; color: #8D6E63; margin-bottom: 12px;" id="battleModeDesc">
                âš¡ æ¶ç­”ï¼šå…ˆç­”å°å¾—åˆ†ï¼Œé¡Œç›®åŒæ­¥åˆ·æ–°
            </div>
            <div>
                <label style="color: #5D4037; font-weight: 600;">é¡Œç›®æ•¸é‡ï¼š</label>
                <select id="totalRoundsSelect" style="padding: 8px 16px; font-size: 1rem; border-radius: 8px; border: 2px solid #FFCC80;">
                    <option value="5">5 é¡Œ</option>
                    <option value="10" selected>10 é¡Œ</option>
                    <option value="15">15 é¡Œ</option>
                    <option value="20">20 é¡Œ</option>
                    <option value="30">30 é¡Œ</option>
                </select>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="createRoom()">ğŸ  å»ºç«‹æˆ¿é–“</button>
            <button class="btn btn-blue" onclick="showJoinRoom()">ğŸšª åŠ å…¥æˆ¿é–“</button>
            <button class="btn btn-gray" onclick="showScreen('startScreen')">â† è¿”å›</button>
        </div>
    </div>
    <script>
        document.getElementById('battleModeSelect')?.addEventListener('change', function() {
            const desc = document.getElementById('battleModeDesc');
            if (this.value === 'race') {
                desc.textContent = 'âš¡ æ¶ç­”ï¼šå…ˆç­”å°å¾—åˆ†ï¼Œé¡Œç›®åŒæ­¥åˆ·æ–°';
            } else {
                desc.textContent = 'ğŸ¯ å„è‡ªï¼šå„ç­”å„çš„ï¼Œå…ˆç­”å®Œå…¨éƒ¨é¡Œç›®ç²å‹';
            }
        });
    </script>

    <!-- ========== ç­‰å¾…ç•«é¢ ========== -->
    <div class="screen hidden" id="waitingScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small thinking">ğŸ¦£</div>
        </div>
        <div class="screen-title" id="waitingTitle">ğŸ  ç­‰å¾…ä¸­</div>
        <div class="screen-sub" id="waitingSub">æˆ¿é–“ç¢¼ï¼š</div>
        <div class="room-code-display" id="roomCodeDisplay">----</div>
        <div class="waiting-text" id="waitingText">â³ ç­‰å¾…å°æ‰‹åŠ å…¥...</div>
        <button class="btn btn-gray" style="margin-top:20px" onclick="cancelWaiting()">å–æ¶ˆ</button>
    </div>

    <!-- ========== åŠ å…¥æˆ¿é–“ ========== -->
    <div class="screen hidden" id="joinScreen">
        <div class="mammoth-container">
            <div class="mammoth mammoth-small">ğŸ¦£</div>
        </div>
        <div class="screen-title">ğŸšª åŠ å…¥æˆ¿é–“</div>
        <div class="screen-sub">è¼¸å…¥ 4 ä½æ•¸æˆ¿é–“ç¢¼</div>
        <div class="room-code-input">
            <input type="tel" maxlength="1" id="code1" oninput="onCodeInput(1)">
            <input type="tel" maxlength="1" id="code2" oninput="onCodeInput(2)">
            <input type="tel" maxlength="1" id="code3" oninput="onCodeInput(3)">
            <input type="tel" maxlength="1" id="code4" oninput="onCodeInput(4)">
        </div>
        <button class="btn btn-green" onclick="joinRoom()">åŠ å…¥éŠæˆ²</button>
        <button class="btn btn-gray" style="margin-top:12px" onclick="showScreen('multiScreen')">â† è¿”å›</button>
    </div>

    <!-- ========== éŠæˆ²ä¸»ç•«é¢ ========== -->
    <div id="gameUI" class="hidden" style="display:flex;flex-direction:column;height:100%">
        <!-- å–®äºº/ç·´ç¿’é ­éƒ¨ -->
        <div class="game-header" id="soloHeader">
            <div class="header-left">
                <div class="badge">â­ <span id="score">0</span></div>
                <div class="streak-stars">
                    <span id="s1">â­</span><span id="s2">â­</span><span id="s3">â­</span><span id="s4">â­</span><span id="s5">â­</span>
                </div>
            </div>
            <div class="header-right">
                <div class="timer" id="timer"></div>
                <div class="badge highlight" id="levelBadge">ç¬¬ 1 é—œ</div>
            </div>
        </div>

        <!-- é›™äººé ­éƒ¨ -->
        <div class="vs-header hidden" id="vsHeader">
            <div class="player-info me">
                <div class="name" id="myName">æˆ‘</div>
                <div class="score" id="myScore">0</div>
                <div class="status" id="myStatus"></div>
            </div>
            <div class="vs-text">VS</div>
            <div class="player-info opp">
                <div class="name" id="oppName">å°æ‰‹</div>
                <div class="score" id="oppScore">0</div>
                <div class="status" id="oppStatus"></div>
            </div>
        </div>

        <div class="game-area">
            <!-- é—œå¡é€²åº¦ -->
            <div class="level-progress" id="levelProgress">
                <span class="label">é—œå¡é€²åº¦</span>
                <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
                <span class="label" id="progressText">0/5</span>
            </div>

            <!-- å¡ç‰‡å€ -->
            <div class="cards-row">
                <div class="card-wrapper">
                    <div class="card-label">ğŸ“‹ é¡Œç›®</div>
                    <div class="big-card target">
                        <div class="card-fill" id="targetFill">
                            <div class="pattern-layer" id="targetPattern"></div>
                        </div>
                    </div>
                </div>
                <div class="card-wrapper">
                    <div class="card-label">âœï¸ ä½œç­”</div>
                    <div class="big-card answer" id="answerCard">
                        <div class="card-fill" id="answerFill">
                            <div class="pattern-layer" id="answerPattern"></div>
                        </div>
                        <div class="drop-hint">æ‹–æ›³é€æ˜ç‰‡<br>åˆ°é€™è£¡</div>
                    </div>
                </div>
            </div>

            <!-- å¤§è±¡ + æç¤ºè¨Šæ¯ -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="mammoth mammoth-mini" id="gameMammoth">ğŸ¦£</div>
                <div class="hint-message" id="hintMessage" style="flex:1;">é¸æ“‡é€æ˜ç‰‡ä¾†é…å°ï¼</div>
            </div>

            <!-- é¡è‰²æç¤º -->
            <div class="color-hints" id="colorHints">
                <div class="hint-item"><span class="hint-dot" style="background:#FF5252"></span>+<span class="hint-dot" style="background:#42A5F5"></span>=<span class="hint-dot" style="background:#9C27B0"></span></div>
                <div class="hint-item"><span class="hint-dot" style="background:#FF5252"></span>+<span class="hint-dot" style="background:#FFD600"></span>=<span class="hint-dot" style="background:#FF9800"></span></div>
                <div class="hint-item"><span class="hint-dot" style="background:#FFD600"></span>+<span class="hint-dot" style="background:#42A5F5"></span>=<span class="hint-dot" style="background:#66BB6A"></span></div>
            </div>

            <!-- é€æ˜ç‰‡ -->
            <div class="filters-area">
                <div class="filter-section">
                    <div class="filter-title">ğŸ¨ é¡è‰²é€æ˜ç‰‡</div>
                    <div class="filter-row" id="colorChips"></div>
                </div>
                <div class="filter-section">
                    <div class="filter-title">âœ¨ èŠ±ç´‹é€æ˜ç‰‡</div>
                    <div class="filter-row" id="patternChips"></div>
                </div>
            </div>

            <!-- æŒ‰éˆ• -->
            <div class="actions">
                <button class="action-btn btn-clear" onclick="clearAnswer()">ğŸ”„ æ¸…é™¤</button>
                <button class="action-btn btn-check" id="checkBtn" onclick="checkAnswer()">âœ… ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- ========== çµæœå½ˆçª— ========== -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-emoji" id="resultEmoji">ğŸ‰</div>
            <div class="mammoth" id="resultMammoth" style="font-size: 3rem;">ğŸ¦£</div>
            <div class="modal-title" id="resultTitle">å¤ªæ£’äº†ï¼</div>
            <div class="modal-sub" id="resultSub">+10 åˆ†</div>
        </div>
    </div>

    <!-- ========== é—œå¡å®Œæˆå½ˆçª— ========== -->
    <div class="modal" id="levelModal">
        <div class="modal-content">
            <div class="mammoth happy" style="font-size: 4rem;">ğŸ¦£</div>
            <div class="modal-title" id="levelTitle">ç¬¬ 1 é—œå®Œæˆï¼</div>
            <div class="modal-sub" id="levelSub">æº–å‚™å¥½æŒ‘æˆ°ä¸‹ä¸€é—œäº†å—ï¼Ÿ</div>
            <button class="btn btn-green modal-btn" onclick="nextLevel()">ç¹¼çºŒæŒ‘æˆ° â†’</button>
        </div>
    </div>

    <!-- ========== éŠæˆ²çµæŸå½ˆçª— ========== -->
    <div class="modal" id="endModal">
        <div class="modal-content">
            <div class="modal-emoji" id="endEmoji">ğŸ†</div>
            <div class="mammoth happy" style="font-size: 3rem;">ğŸ¦£</div>
            <div class="modal-title" id="endTitle">éŠæˆ²çµæŸ</div>
            <div class="modal-sub" id="endSub">æœ€çµ‚åˆ†æ•¸ï¼š0</div>
            <button class="btn btn-green modal-btn" onclick="backToStart()">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

    <!-- ========== å½©å¸¶å®¹å™¨ ========== -->
    <div class="confetti" id="confetti"></div>

    <script>
        // ==================== é…ç½® ====================
        const COLORS = {
            // åŸºæœ¬è‰²
            red: '#FF5252',
            yellow: '#FFD600',
            blue: '#42A5F5',
            black: '#424242',     // é»‘ï¼ˆæ·±ç°ï¼Œä¸è¦ç´”é»‘ï¼‰
            white: '#FAFAFA',     // ç™½ï¼ˆç±³ç™½ï¼Œä¸è¦ç´”ç™½ï¼‰
            // é›™è‰²æ··åˆ
            'blue+red': '#9C27B0',       // ç´«
            'red+yellow': '#FF9800',     // æ©™
            'blue+yellow': '#66BB6A',    // ç¶ 
            'black+red': '#B71C1C',      // æ·±ç´…/é…’ç´…
            'black+yellow': '#827717',   // æ·±é»ƒ/æ©„æ¬–
            'black+blue': '#1A237E',     // æ·±è—/æµ·è»è—
            'red+white': '#FFCDD2',      // æ·ºç´…/ç²‰
            'white+yellow': '#FFF9C4',   // æ·ºé»ƒ/å¥¶æ²¹
            'blue+white': '#BBDEFB',     // æ·ºè—/å¤©ç©ºè—
            'black+white': '#9E9E9E',    // ç°
            // ä¸‰è‰²æ··åˆ
            'blue+red+yellow': '#8D6E63',    // æ£•
            'black+blue+red': '#311B92',     // æ·±ç´«
            'black+red+yellow': '#3E2723',   // æ·±æ£•/å’–å•¡ï¼ˆæ›´æ·±ä»¥å€åˆ†æ£•è‰²ï¼‰
            'black+blue+yellow': '#33691E',  // æ·±ç¶ /æ£®æ—ç¶ 
            'blue+red+white': '#E1BEE7',     // æ·ºç´«/è–°è¡£è‰
            'red+white+yellow': '#FFE0B2',   // æ·ºæ©™/èœœæ¡ƒ
            'blue+white+yellow': '#C8E6C9',  // æ·ºç¶ /è–„è·
            'black+red+white': '#A1887F',    // ç«ç‘°æ£•
            'black+white+yellow': '#A1887F', // å¡å…¶
            'black+blue+white': '#78909C',   // è—ç°
            // å››è‰²æ··åˆ
            'black+blue+red+yellow': '#4E342E',  // æ·±æ£•
            'blue+red+white+yellow': '#D7CCC8',  // æ·ºæ£•/ç±³è‰²
            'black+blue+red+white': '#5D4037',   // æ‘©å¡
            'black+blue+white+yellow': '#607D8B', // çŸ³æ¿ç°
            'black+red+white+yellow': '#A1887F', // é§è‰²ï¼ˆèª¿æ·ºä»¥å€åˆ†æ£•è‰²ï¼‰
            // äº”è‰²æ··åˆ
            'black+blue+red+white+yellow': '#6D4C41' // æ·±é§è‰²
        };

        const COLOR_NAMES = {
            red: 'ç´…è‰²',
            yellow: 'é»ƒè‰²',
            blue: 'è—è‰²',
            black: 'é»‘è‰²',
            white: 'ç™½è‰²',
            'blue+red': 'ç´«è‰²',
            'red+yellow': 'æ©™è‰²',
            'blue+yellow': 'ç¶ è‰²',
            'blue+red+yellow': 'æ£•è‰²',
            'black+red': 'æ·±ç´…',
            'black+yellow': 'æ©„æ¬–è‰²',
            'black+blue': 'æ·±è—',
            'red+white': 'ç²‰ç´…',
            'white+yellow': 'å¥¶æ²¹è‰²',
            'blue+white': 'å¤©ç©ºè—',
            'black+white': 'ç°è‰²',
            // ä¸‰è‰²çµ„åˆ
            'black+red+yellow': 'æ·±æ©™',
            'black+blue+red': 'æ·±ç´«',
            'black+blue+yellow': 'æ·±ç¶ ',
            'blue+red+white': 'æ·ºç´«',
            'red+white+yellow': 'æ·ºæ©™',
            'blue+white+yellow': 'æ·ºç¶ ',
            'black+red+white': 'ç«ç‘°ç°',
            'black+white+yellow': 'å¡å…¶è‰²',
            'black+blue+white': 'è—ç°è‰²',
            // å››è‰²çµ„åˆ
            'black+blue+red+yellow': 'æ·±æ£•',
            'blue+red+white+yellow': 'æ·ºæ£•',
            'black+blue+red+white': 'æ‘©å¡è‰²',
            'black+blue+white+yellow': 'çŸ³æ¿ç°',
            'black+red+white+yellow': 'é§è‰²',
            // äº”è‰²
            'black+blue+red+white+yellow': 'æ·±é§è‰²'
        };

        const PATTERNS = ['dots', 'stripes', 'grid', 'zigzag', 'circles'];

        // é—œå¡é…ç½®
        const LEVELS = [
            { colors: ['red', 'yellow', 'blue'], patterns: ['dots'], questionsPerLevel: 3, timeLimit: 0 },
            { colors: ['red', 'yellow', 'blue'], patterns: ['dots', 'stripes'], questionsPerLevel: 4, timeLimit: 0 },
            { colors: ['red', 'yellow', 'blue'], patterns: ['dots', 'stripes', 'grid'], questionsPerLevel: 4, timeLimit: 30 },
            { colors: ['red', 'yellow', 'blue'], patterns: ['dots', 'stripes', 'grid'], questionsPerLevel: 5, timeLimit: 25, mixColors: true },
            { colors: ['red', 'yellow', 'blue'], patterns: ['dots', 'stripes', 'grid', 'zigzag'], questionsPerLevel: 5, timeLimit: 20, mixColors: true },
            { colors: ['red', 'yellow', 'blue', 'black'], patterns: PATTERNS.slice(0, 4), questionsPerLevel: 5, timeLimit: 18, mixColors: true },
            { colors: ['red', 'yellow', 'blue', 'black', 'white'], patterns: PATTERNS, questionsPerLevel: 6, timeLimit: 15, mixColors: true },
            { colors: ['red', 'yellow', 'blue', 'black', 'white'], patterns: PATTERNS, questionsPerLevel: 6, timeLimit: 12, mixColors: true, tripleColors: true },
            { colors: ['red', 'yellow', 'blue', 'black', 'white'], patterns: PATTERNS, questionsPerLevel: 7, timeLimit: 10, mixColors: true, tripleColors: true },
            { colors: ['red', 'yellow', 'blue', 'black', 'white'], patterns: PATTERNS, questionsPerLevel: 8, timeLimit: 8, mixColors: true, tripleColors: true }
        ];

        // å¤§è±¡èªªè©±å…§å®¹
        const MAMMOTH_SPEECHES = {
            start: ['å—¨ï¼ä¸€èµ·ç©é¡è‰²éŠæˆ²å§ï¼', 'ä»Šå¤©æƒ³æ··ä»€éº¼é¡è‰²å‘¢ï¼Ÿ', 'æº–å‚™å¥½è®Šé­”æ³•äº†å—ï¼Ÿ'],
            correct: ['å¤ªæ£’äº†ï¼ğŸ‰', 'ä½ å¥½å²å®³ï¼', 'å®Œç¾ï¼âœ¨', 'è®šè®šè®šï¼', 'Wowï¼è¶…å¼·ï¼'],
            wrong: ['å†æƒ³æƒ³çœ‹ï½', 'åˆ¥ç°å¿ƒï¼Œå†è©¦ä¸€æ¬¡ï¼', 'æç¤ºï¼šä»”ç´°çœ‹é¡è‰²å–”', 'åŠ æ²¹ï¼Œä½ å¯ä»¥çš„ï¼'],
            streak: ['ç‡ƒèµ·ä¾†äº†ï¼ğŸ”¥', 'é€£çºŒç­”å°ï¼å¤ªå²å®³ï¼', 'å‹¢ä¸å¯æ“‹ï¼âš¡'],
            tutorial: ['è®“æˆ‘æ•™ä½ é¡è‰²æ€éº¼æ··åˆï¼', 'ç´…+è—=ç´«è‰²å–”ï¼', 'è©¦è©¦çœ‹å§ï¼']
        };

        // æç¤ºè¨Šæ¯
        const CORRECT_MESSAGES = [
            "ğŸ‰ å¤ªæ£’äº†ï¼", "âœ¨ å®Œç¾ï¼", "ğŸ‘ æ¼‚äº®ï¼", "ğŸŒŸ å²å®³ï¼", "ğŸ’ª è¶…å¼·ï¼",
            "ğŸ”¥ ç‡ƒç‡’å§ï¼", "âš¡ å¿«å¦‚é–ƒé›»ï¼", "ğŸš€ ç„¡äººèƒ½æ“‹ï¼", "ğŸ‘‘ ç‹è€…é¢¨ç¯„ï¼"
        ];

        const WRONG_MESSAGES = [
            "ğŸ¤” å†æƒ³æƒ³çœ‹...", "ğŸ’­ é¡è‰²å°å—ï¼Ÿ", "ğŸ¨ èŠ±ç´‹å‘¢ï¼Ÿ", "ğŸ‘€ ä»”ç´°çœ‹çœ‹é¡Œç›®",
            "ğŸ’ª åŠ æ²¹ï¼Œä½ å¯ä»¥çš„ï¼", "ğŸŒˆ æƒ³æƒ³é¡è‰²æ€éº¼æ··åˆ"
        ];

        const STREAK_MESSAGES = [
            "", "ğŸ”¥ é€£çºŒ 2 é¡Œï¼", "âš¡ é€£çºŒ 3 é¡Œï¼", "ğŸ’¥ é€£çºŒ 4 é¡Œï¼", "ğŸ‘‘ é€£çºŒ 5 é¡Œï¼è¶…ç¥ï¼"
        ];

        // ==================== éŠæˆ²ç‹€æ…‹ ====================
        let gameMode = 'adventure'; // adventure / freeplay / multi
        let currentLevel = 1;
        let questionsInLevel = 0;
        let score = 0;
        let streak = 0;
        let wrongCount = 0;
        let timeLeft = 0;
        let timerInterval = null;

        let availableColors = ['red', 'yellow', 'blue'];
        let availablePatterns = ['dots', 'stripes', 'grid'];
        let currentConfig = LEVELS[0];

        let selectedColors = new Set();
        let selectedPattern = null;
        let targetColorKey = '';
        let targetPattern = '';
        let lastQuestionKey = '';  // è¨˜éŒ„ä¸Šä¸€é¡Œï¼Œé¿å…é€£çºŒé‡è¤‡

        // é›™äºº
        let roomCode = null;
        let playerId = null;
        let playerIndex = 0;
        let pollInterval = null;
        let gameStarted = false;
        let currentRound = 0;

        // æ•™å­¸ç·´ç¿’
        let practiceColors = new Set();
        let practicePattern = null;

        // DOM
        const $ = id => document.getElementById(id);
        const answerCard = $('answerCard');

        // ==================== å¤§è±¡å‹•ç•«æ§åˆ¶ ====================
        function setMammothState(elementId, state) {
            const mammoth = $(elementId);
            if (!mammoth) return;
            
            mammoth.classList.remove('happy', 'sad', 'thinking');
            if (state) {
                mammoth.classList.add(state);
            }
        }

        function showMammothSpeech(speechId, category) {
            const speech = $(speechId);
            if (!speech) return;
            
            const messages = MAMMOTH_SPEECHES[category];
            if (!messages) return;
            
            speech.textContent = messages[Math.floor(Math.random() * messages.length)];
            speech.classList.add('show');
            
            setTimeout(() => {
                speech.classList.remove('show');
            }, 2500);
        }

        function triggerMammothReaction(isCorrect) {
            const gameMammoth = $('gameMammoth');
            const resultMammoth = $('resultMammoth');
            
            if (isCorrect) {
                setMammothState('gameMammoth', 'happy');
                if (resultMammoth) resultMammoth.classList.add('happy');
                
                setTimeout(() => {
                    setMammothState('gameMammoth', null);
                    if (resultMammoth) resultMammoth.classList.remove('happy');
                }, 1200);
            } else {
                setMammothState('gameMammoth', 'sad');
                if (resultMammoth) resultMammoth.classList.add('sad');
                
                setTimeout(() => {
                    setMammothState('gameMammoth', null);
                    if (resultMammoth) resultMammoth.classList.remove('sad');
                }, 800);
            }
        }

        // ==================== éŸ³æ•ˆ ====================
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        document.addEventListener('touchstart', () => {
            if (!audioCtx) audioCtx = new AudioCtx();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

        function playSound(freq, duration = 0.15, type = 'sine', volume = 0.4, delay = 0) {
            if (!audioCtx) audioCtx = new AudioCtx();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            try {
                const t = audioCtx.currentTime + delay;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(volume, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
                osc.start(t);
                osc.stop(t + duration);
            } catch(e) {}
        }

        function playSuccess() {
            [523, 587, 659, 698, 784, 880, 988, 1047].forEach((f, i) => {
                playSound(f, 0.2, 'sine', 0.35, i * 0.08);
            });
            setTimeout(() => {
                playSound(1047, 0.3, 'sine', 0.3);
                playSound(1319, 0.3, 'sine', 0.25);
                playSound(1568, 0.3, 'sine', 0.2);
            }, 350);
        }

        function playWrong() {
            playSound(300, 0.15, 'triangle', 0.3);
            setTimeout(() => playSound(200, 0.2, 'triangle', 0.25), 100);
        }

        function playDrop() {
            playSound(1200, 0.08, 'sine', 0.3);
            playSound(1600, 0.05, 'sine', 0.15, 0.03);
        }

        function playTick() {
            playSound(800, 0.05, 'sine', 0.2);
        }

        function playLevelUp() {
            [523, 659, 784, 1047, 1319, 1568].forEach((f, i) => {
                playSound(f, 0.25, 'sine', 0.3, i * 0.1);
            });
        }

        // ==================== ç•«é¢æ§åˆ¶ ====================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if (id) $(id).classList.remove('hidden');
            
            // é¡¯ç¤ºé–‹å§‹ç•«é¢æ™‚æ’­æ”¾å¤§è±¡å‹•ç•«
            if (id === 'startScreen') {
                setTimeout(() => showMammothSpeech('startSpeech', 'start'), 500);
            }
        }

        function showModeSelect() { showScreen('modeScreen'); }
        function showFreePlay() { showScreen('freePlayScreen'); }
        function showMultiMenu() { showScreen('multiScreen'); }

        function showTutorial() {
            showScreen('tutorialScreen');
            setTimeout(() => showMammothSpeech('tutorialSpeech', 'tutorial'), 300);
            clearPractice();
            initPractice();
        }

        function showJoinRoom() {
            showScreen('joinScreen');
            for (let i = 1; i <= 4; i++) $('code' + i).value = '';
            $('code1').focus();
        }

        function onCodeInput(n) {
            if ($('code' + n).value && n < 4) $('code' + (n + 1)).focus();
        }

        // ==================== æ•™å­¸ç·´ç¿’å€ï¼ˆç°¡åŒ–ç‰ˆï¼Œåªç”¨é»æ“Šï¼‰ ====================
        function initPractice() {
            // ç¶å®šé¡è‰²é»æ“Š
            document.querySelectorAll('#practiceChips .practice-chip').forEach(chip => {
                chip.onclick = function() {
                    const color = this.dataset.color;
                    if (!color) return;
                    if (practiceColors.has(color)) {
                        practiceColors.delete(color);
                        this.classList.remove('selected');
                    } else {
                        practiceColors.add(color);
                        this.classList.add('selected');
                    }
                    updatePractice();
                };
            });
            
            // ç¶å®šèŠ±ç´‹é»æ“Š
            document.querySelectorAll('#practicePatterns .practice-chip').forEach(chip => {
                chip.onclick = function() {
                    const pattern = this.dataset.pattern;
                    if (!pattern) return;
                    // ç§»é™¤å…¶ä»–èŠ±ç´‹çš„é¸ä¸­
                    document.querySelectorAll('#practicePatterns .practice-chip').forEach(c => c.classList.remove('selected'));
                    if (practicePattern === pattern) {
                        practicePattern = null;
                    } else {
                        practicePattern = pattern;
                        this.classList.add('selected');
                    }
                    updatePractice();
                };
            });
        }

        function updatePractice() {
            const fill = $('practiceDropzoneFill');
            const patternLayer = $('practicePatternLayer');
            const hint = $('practiceHint');
            const result = $('practiceResult');
            
            // æ›´æ–°èŠ±ç´‹
            if (patternLayer) {
                patternLayer.className = 'practice-pattern-layer' + (practicePattern ? ' active ' + practicePattern : '');
            }
            
            if (practiceColors.size > 0) {
                const colorKey = [...practiceColors].sort().join('+');
                const color = COLORS[colorKey] || COLORS[[...practiceColors][0]];
                const name = COLOR_NAMES[colorKey] || COLOR_NAMES[[...practiceColors][0]] || colorKey;
                
                fill.style.background = color || '#888';
                hint.style.display = 'none';
                
                let resultText = `<strong>${name}</strong>`;
                if (practicePattern) {
                    const patternNames = { dots: 'é»é»', stripes: 'æ–œæ¢ç´‹', grid: 'æ ¼å­' };
                    resultText += ` + ${patternNames[practicePattern]}`;
                }
                result.innerHTML = resultText;
            } else {
                fill.style.background = '#F5F5F5';
                hint.style.display = '';
                result.textContent = 'é»é¸é¡è‰²è©¦è©¦çœ‹ï¼';
            }
        }

        function clearPractice() {
            practiceColors.clear();
            practicePattern = null;
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.practice-chip').forEach(c => c.classList.remove('selected'));
            updatePractice();
        }

        // ==================== å–®äººé—˜é—œæ¨¡å¼ ====================
        function startAdventure() {
            gameMode = 'adventure';
            currentLevel = 1;
            questionsInLevel = 0;
            score = 0;
            streak = 0;
            loadLevelConfig();
            setupGameUI();
            showScreen(null);
            $('gameUI').classList.remove('hidden');
            $('soloHeader').classList.remove('hidden');
            $('vsHeader').classList.add('hidden');
            $('levelProgress').classList.remove('hidden');
            newQuestion();
        }

        function loadLevelConfig() {
            currentConfig = LEVELS[Math.min(currentLevel - 1, LEVELS.length - 1)];
            availableColors = currentConfig.colors;
            availablePatterns = currentConfig.patterns;
            updateLevelUI();
        }

        function updateLevelUI() {
            $('levelBadge').textContent = `ç¬¬ ${currentLevel} é—œ`;
            $('progressText').textContent = `${questionsInLevel}/${currentConfig.questionsPerLevel}`;
            $('progressFill').style.width = `${(questionsInLevel / currentConfig.questionsPerLevel) * 100}%`;
        }

        function setupGameUI() {
            // è¨­ç½®å¯ç”¨çš„é¡è‰²å¡ç‰‡
            const colorRow = $('colorChips');
            colorRow.innerHTML = availableColors.map(c => 
                `<div class="draggable-chip color-${c}" data-type="color" data-value="${c}"></div>`
            ).join('');

            // è¨­ç½®å¯ç”¨çš„èŠ±ç´‹å¡ç‰‡
            const patternRow = $('patternChips');
            patternRow.innerHTML = availablePatterns.map(p => 
                `<div class="draggable-chip pattern-chip" data-type="pattern" data-value="${p}"><div class="chip-pattern ${p}"></div></div>`
            ).join('');

            initDrag();
            updateScoreUI();
            
            // é‡ç½®å¤§è±¡ç‹€æ…‹
            setMammothState('gameMammoth', null);
        }

        function updateScoreUI() {
            $('score').textContent = score;
            for (let i = 1; i <= 5; i++) {
                $('s' + i).classList.toggle('active', i <= streak);
            }
        }

        // ==================== è‡ªç”±ç·´ç¿’æ¨¡å¼ ====================
        function startFreePlay(difficulty) {
            gameMode = 'freeplay';
            score = 0;
            streak = 0;

            if (difficulty === 'easy') {
                availableColors = ['red', 'yellow', 'blue'];
                availablePatterns = ['dots', 'stripes'];
                currentConfig = { mixColors: false, timeLimit: 0 };
            } else if (difficulty === 'medium') {
                availableColors = ['red', 'yellow', 'blue'];
                availablePatterns = ['dots', 'stripes', 'grid'];
                currentConfig = { mixColors: true, timeLimit: 0 };
            } else {
                availableColors = ['red', 'yellow', 'blue', 'black', 'white'];
                availablePatterns = PATTERNS;
                currentConfig = { mixColors: true, tripleColors: true, timeLimit: 15 };
            }

            setupGameUI();
            showScreen(null);
            $('gameUI').classList.remove('hidden');
            $('soloHeader').classList.remove('hidden');
            $('vsHeader').classList.add('hidden');
            $('levelProgress').classList.add('hidden');
            $('levelBadge').textContent = difficulty === 'easy' ? 'ç°¡å–®' : difficulty === 'medium' ? 'æ™®é€š' : 'å›°é›£';
            newQuestion();
        }

        // ==================== é¡Œç›®ç”Ÿæˆ ====================
        function newQuestion() {
            clearAnswer();
            wrongCount = 0;

            // æœ€å¤šå˜—è©¦ 10 æ¬¡é¿å…ç„¡é™è¿´åœˆ
            let attempts = 0;
            let newColorKey, newPattern;
            
            do {
                // ç”Ÿæˆé¡è‰²çµ„åˆ
                let colorCombo;
                if (currentConfig.tripleColors && Math.random() < 0.3) {
                    // ä¸‰è‰²æ··åˆ
                    colorCombo = ['red', 'yellow', 'blue'];
                } else if (currentConfig.mixColors && Math.random() < 0.6) {
                    // é›™è‰²æ··åˆ
                    const shuffled = [...availableColors].sort(() => Math.random() - 0.5);
                    colorCombo = shuffled.slice(0, 2);
                } else {
                    // å–®è‰²
                    colorCombo = [availableColors[Math.floor(Math.random() * availableColors.length)]];
                }

                newColorKey = colorCombo.sort().join('+');
                newPattern = availablePatterns[Math.floor(Math.random() * availablePatterns.length)];
                attempts++;
            } while (newColorKey + '|' + newPattern === lastQuestionKey && attempts < 10);

            targetColorKey = newColorKey;
            targetPattern = newPattern;
            lastQuestionKey = targetColorKey + '|' + targetPattern;

            // é¡¯ç¤ºé¡Œç›®
            const color = COLORS[targetColorKey] || COLORS[colorCombo[0]];
            $('targetFill').style.background = color;
            $('targetPattern').className = 'pattern-layer active ' + targetPattern;

            $('hintMessage').textContent = 'é¸æ“‡é€æ˜ç‰‡ä¾†é…å°ï¼';
            
            // å¤§è±¡é€²å…¥æ€è€ƒç‹€æ…‹
            setMammothState('gameMammoth', 'thinking');

            // è¨ˆæ™‚å™¨
            if (currentConfig.timeLimit > 0) {
                startTimer(currentConfig.timeLimit);
            } else {
                $('timer').textContent = '';
            }
        }

        // ==================== è¨ˆæ™‚å™¨ ====================
        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = seconds;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 5 && timeLeft > 0) {
                    playTick();
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timer = $('timer');
            timer.textContent = `â±ï¸ ${timeLeft}`;
            timer.className = 'timer' + (timeLeft <= 3 ? ' danger' : timeLeft <= 5 ? ' warning' : '');
        }

        function handleTimeout() {
            playWrong();
            streak = 0;
            updateScoreUI();
            triggerMammothReaction(false);
            showResult(false, 'â° æ™‚é–“åˆ°ï¼');
            setTimeout(newQuestion, 1500);
        }

        // ==================== ç­”æ¡ˆæª¢æŸ¥ ====================
        function checkAnswer() {
            if (selectedColors.size === 0) {
                $('hintMessage').textContent = 'ğŸ‘† å…ˆé¸æ“‡é¡è‰²é€æ˜ç‰‡ï¼';
                return;
            }

            clearInterval(timerInterval);

            const answerKey = [...selectedColors].sort().join('+');
            const correct = answerKey === targetColorKey && selectedPattern === targetPattern;

            if (correct) {
                // ç­”å°
                streak++;
                const bonus = Math.min(streak - 1, 4) * 5;
                const timeBonus = timeLeft > 0 ? Math.floor(timeLeft / 2) : 0;
                const points = 10 + bonus + timeBonus;
                score += points;
                questionsInLevel++;
                
                updateScoreUI();
                updateLevelUI();

                const msg = streak > 1 ? STREAK_MESSAGES[Math.min(streak, 5)] : CORRECT_MESSAGES[Math.floor(Math.random() * CORRECT_MESSAGES.length)];
                playSuccess();
                triggerMammothReaction(true);
                showResult(true, msg, `+${points} åˆ†`);

                if (streak >= 5) showConfetti();

                setTimeout(() => {
                    if (gameMode === 'adventure' && questionsInLevel >= currentConfig.questionsPerLevel) {
                        showLevelComplete();
                    } else {
                        newQuestion();
                    }
                }, 1300);
            } else {
                // ç­”éŒ¯
                wrongCount++;
                streak = 0;
                updateScoreUI();

                let hint = WRONG_MESSAGES[Math.floor(Math.random() * WRONG_MESSAGES.length)];
                if (wrongCount >= 3) {
                    hint = `ğŸ’¡ æç¤ºï¼šéœ€è¦ ${targetColorKey.split('+').length} ç¨®é¡è‰²`;
                }

                playWrong();
                triggerMammothReaction(false);
                showResult(false, hint);

                // é‡å•Ÿè¨ˆæ™‚å™¨
                if (currentConfig.timeLimit > 0) {
                    setTimeout(() => startTimer(currentConfig.timeLimit), 1500);
                }
            }
        }

        function showResult(success, title, sub = '') {
            $('resultEmoji').textContent = success ? 'ğŸ‰' : 'ğŸ¤”';
            $('resultTitle').textContent = title;
            $('resultSub').textContent = sub;
            
            const resultMammoth = $('resultMammoth');
            resultMammoth.className = 'mammoth ' + (success ? 'happy' : 'sad');
            
            $('resultModal').classList.add('show');
            setTimeout(() => $('resultModal').classList.remove('show'), 1200);
        }

        function showLevelComplete() {
            playLevelUp();
            showConfetti();
            $('levelTitle').textContent = `ç¬¬ ${currentLevel} é—œå®Œæˆï¼`;
            $('levelSub').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            $('levelModal').classList.add('show');
        }

        function nextLevel() {
            $('levelModal').classList.remove('show');
            currentLevel++;
            questionsInLevel = 0;

            if (currentLevel > LEVELS.length) {
                // å…¨éƒ¨é€šé—œ
                showGameEnd('ğŸ†', 'æ­å–œé€šé—œï¼', `æœ€çµ‚åˆ†æ•¸ï¼š${score} åˆ†`);
            } else {
                loadLevelConfig();
                setupGameUI();
                newQuestion();
            }
        }

        function showGameEnd(emoji, title, sub) {
            $('endEmoji').textContent = emoji;
            $('endTitle').textContent = title;
            $('endSub').textContent = sub;
            $('endModal').classList.add('show');
        }

        function backToStart() {
            $('endModal').classList.remove('show');
            $('levelModal').classList.remove('show');
            $('gameUI').classList.add('hidden');
            clearInterval(timerInterval);
            clearInterval(pollInterval);
            showScreen('startScreen');
        }

        // ==================== å½©å¸¶æ•ˆæœ ====================
        function showConfetti() {
            const container = $('confetti');
            container.innerHTML = '';
            const colors = ['#FF6B6B', '#FFE066', '#74C0FC', '#81C784', '#FFB74D', '#BA68C8'];

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + '%';
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(piece);
            }

            setTimeout(() => container.innerHTML = '', 3000);
        }

        // ==================== æ‹–æ›³æ“ä½œ ====================
        let dragGhost = null;
        let dragData = null;
        let dragStartPos = null;  // è¨˜éŒ„æ‹–æ›³èµ·å§‹ä½ç½®
        const DRAG_THRESHOLD = 10;  // ç§»å‹•è¶…éé€™å€‹è·é›¢æ‰ç®—æ‹–æ›³
        let practiceDragGhost = null;  // ç·´ç¿’æ¨¡å¼æ‹–æ›³ï¼ˆé¿å…è¡çªç”¨ï¼‰

        let lastTouchTime = 0;
        
        function initDrag() {
            document.querySelectorAll('.draggable-chip').forEach(chip => {
                chip.removeEventListener('touchstart', onTouchStart);
                chip.removeEventListener('mousedown', onMouseStart);
                chip.addEventListener('touchstart', onTouchStart, { passive: false });
                chip.addEventListener('mousedown', onMouseStart);
            });
        }
        
        function onTouchStart(e) {
            e.preventDefault();  // é˜²æ­¢ç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚º
            lastTouchTime = Date.now();
            onDragStart(e);
        }
        
        function onMouseStart(e) {
            // å¦‚æœå‰›è§¸ç™¼é touchï¼Œè·³é mouse äº‹ä»¶
            if (Date.now() - lastTouchTime < 500) return;
            onDragStart(e);
        }

        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchend', onTouchEnd);
        document.addEventListener('mouseup', onMouseEnd);
        
        function onTouchEnd(e) {
            lastTouchTime = Date.now();
            onDragEnd(e);
        }
        
        function onMouseEnd(e) {
            if (Date.now() - lastTouchTime < 500) return;
            onDragEnd(e);
        }

        function onDragStart(e) {
            if (practiceDragGhost) return; // é¿å…è¡çª
            const chip = e.currentTarget;
            if (chip.classList.contains('locked')) return;

            const pos = e.touches ? e.touches[0] : e;
            dragStartPos = { x: pos.clientX, y: pos.clientY };
            dragData = { type: chip.dataset.type, value: chip.dataset.value, chip };
            // å…ˆä¸å‰µå»º ghostï¼Œç­‰ç¢ºèªæ˜¯æ‹–æ›³æ‰å‰µå»º
        }

        function onDragMove(e) {
            if (practiceDragGhost) return;
            if (!dragData || !dragStartPos) return;
            
            const pos = e.touches ? e.touches[0] : e;
            const dx = pos.clientX - dragStartPos.x;
            const dy = pos.clientY - dragStartPos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // å¦‚æœé‚„æ²’å‰µå»º ghostï¼Œæª¢æŸ¥æ˜¯å¦è¶…éé–¾å€¼
            if (!dragGhost) {
                if (distance < DRAG_THRESHOLD) return;
                // è¶…éé–¾å€¼ï¼Œå‰µå»º ghostï¼Œé–‹å§‹æ‹–æ›³
                e.preventDefault();
                dragData.chip.classList.add('dragging');
                
                dragGhost = document.createElement('div');
                dragGhost.className = 'drag-ghost';
                if (dragData.type === 'color') {
                    dragGhost.style.background = getComputedStyle(dragData.chip).background;
                } else {
                    dragGhost.style.background = '#EEE';
                    const pat = document.createElement('div');
                    pat.className = 'chip-pattern ' + dragData.value;
                    pat.style.borderRadius = '14px';
                    dragGhost.appendChild(pat);
                }
                document.body.appendChild(dragGhost);
            }
            
            e.preventDefault();
            dragGhost.style.left = pos.clientX + 'px';
            dragGhost.style.top = pos.clientY + 'px';

            const rect = answerCard.getBoundingClientRect();
            const over = pos.clientX >= rect.left && pos.clientX <= rect.right && 
                         pos.clientY >= rect.top && pos.clientY <= rect.bottom;
            answerCard.classList.toggle('drag-over', over);
        }

        function onDragEnd(e) {
            if (practiceDragGhost) return;
            
            // å¦‚æœæ²’æœ‰æ‹–æ›³æ•¸æ“šï¼Œç›´æ¥è¿”å›
            if (!dragData) return;
            
            // å¦‚æœæ²’æœ‰å‰µå»º ghostï¼ˆæ²’æœ‰çœŸæ­£æ‹–æ›³ï¼‰ï¼Œç•¶ä½œé»æ“Šè™•ç†
            if (!dragGhost) {
                // åˆ‡æ›é¸æ“‡ç‹€æ…‹
                const type = dragData.type;
                const value = dragData.value;
                const chip = dragData.chip;
                
                if (type === 'color') {
                    if (chip.classList.contains('used')) {
                        selectedColors.delete(value);
                        chip.classList.remove('used');
                    } else {
                        selectedColors.add(value);
                        chip.classList.add('used');
                    }
                } else {
                    if (chip.classList.contains('used')) {
                        selectedPattern = null;
                        chip.classList.remove('used');
                    } else {
                        document.querySelectorAll('.pattern-chip').forEach(c => c.classList.remove('used'));
                        selectedPattern = value;
                        chip.classList.add('used');
                    }
                }
                updateAnswerDisplay();
                playDrop();
                
                dragData = null;
                dragStartPos = null;
                return;
            }

            // æœ‰æ‹–æ›³ï¼Œè™•ç†æ”¾ç½®
            const pos = e.changedTouches ? e.changedTouches[0] : e;
            const rect = answerCard.getBoundingClientRect();
            const over = pos.clientX >= rect.left && pos.clientX <= rect.right && 
                         pos.clientY >= rect.top && pos.clientY <= rect.bottom;

            if (over) {
                applyChip(dragData.type, dragData.value);
                dragData.chip.classList.add('used');
                playDrop();
            }

            dragData.chip.classList.remove('dragging');
            answerCard.classList.remove('drag-over');
            dragGhost.remove();
            dragGhost = null;
            dragData = null;
            dragStartPos = null;
        }

        function applyChip(type, value) {
            if (type === 'color') {
                selectedColors.add(value);
            } else {
                document.querySelectorAll('.pattern-chip').forEach(c => c.classList.remove('used'));
                selectedPattern = value;
            }
            updateAnswerDisplay();
        }

        function updateAnswerDisplay() {
            const hasContent = selectedColors.size > 0 || selectedPattern;
            answerCard.classList.toggle('has-content', hasContent);

            if (selectedColors.size > 0) {
                const colorKey = [...selectedColors].sort().join('+');
                const color = COLORS[colorKey] || COLORS[[...selectedColors][0]];
                $('answerFill').style.background = color;
            } else {
                $('answerFill').style.background = '#F5F5F5';
            }

            $('answerPattern').className = 'pattern-layer' + (selectedPattern ? ' active ' + selectedPattern : '');
        }

        function clearAnswer() {
            selectedColors.clear();
            selectedPattern = null;
            document.querySelectorAll('.draggable-chip').forEach(c => c.classList.remove('used'));
            $('answerFill').style.background = '#F5F5F5';
            $('answerPattern').className = 'pattern-layer';
            answerCard.classList.remove('has-content');
        }

        // ==================== é›™äººéŠæˆ² ====================
        async function createRoom() {
            try {
                const totalRounds = parseInt($('totalRoundsSelect')?.value || '10');
                const battleMode = $('battleModeSelect')?.value || 'race';
                const res = await fetch('/api/game/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerName: 'ç©å®¶1', mode: 'hard', totalRounds, battleMode })
                }).then(r => r.json());

                if (res.success) {
                    roomCode = res.code;
                    playerId = res.playerId;
                    playerIndex = 0;
                    $('waitingTitle').textContent = 'ğŸ  æˆ¿é–“å·²å»ºç«‹';
                    $('waitingSub').textContent = 'å‘Šè¨´æœ‹å‹æˆ¿é–“ç¢¼ï¼š';
                    $('roomCodeDisplay').textContent = roomCode;
                    $('waitingText').textContent = 'â³ ç­‰å¾…å°æ‰‹åŠ å…¥...';
                    showScreen('waitingScreen');
                    startPolling();
                }
            } catch (e) {
                alert('å»ºç«‹æˆ¿é–“å¤±æ•—');
            }
        }

        async function joinRoom() {
            const code = $('code1').value + $('code2').value + $('code3').value + $('code4').value;
            if (code.length !== 4) return alert('è«‹è¼¸å…¥å®Œæ•´æˆ¿é–“ç¢¼');

            try {
                const res = await fetch('/api/game/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, playerName: 'ç©å®¶2' })
                }).then(r => r.json());

                if (res.error) return alert(res.error);

                roomCode = code;
                playerId = res.playerId;
                playerIndex = 1;
                $('waitingTitle').textContent = 'ğŸšª å·²åŠ å…¥æˆ¿é–“';
                $('waitingSub').textContent = '';
                $('roomCodeDisplay').textContent = 'æº–å‚™ä¸­...';
                $('waitingText').textContent = 'â³ ç­‰å¾…éŠæˆ²é–‹å§‹...';
                showScreen('waitingScreen');
                startPolling();
            } catch (e) {
                alert('åŠ å…¥æˆ¿é–“å¤±æ•—');
            }
        }

        function cancelWaiting() {
            clearInterval(pollInterval);
            roomCode = null;
            showScreen('multiScreen');
        }

        function startPolling() {
            gameStarted = false;
            currentRound = 0;

            pollInterval = setInterval(async () => {
                try {
                    const room = await fetch(`/api/game/room/${roomCode}`).then(r => r.json());
                    if (room.error) return;

                    if (room.status === 'ready' && playerIndex === 0) {
                        await fetch(`/api/game/start/${roomCode}`, { method: 'POST' });
                    } else if (room.status === 'playing') {
                        if (!gameStarted) {
                            gameStarted = true;
                            gameMode = 'multi';
                            availableColors = ['red', 'yellow', 'blue', 'black', 'white'];
                            availablePatterns = ['dots', 'stripes', 'grid'];
                            currentConfig = { mixColors: true, timeLimit: 0 };
                            setupGameUI();
                            showScreen(null);
                            $('gameUI').classList.remove('hidden');
                            $('soloHeader').classList.add('hidden');
                            $('vsHeader').classList.remove('hidden');
                            $('levelProgress').classList.add('hidden');
                            $('myName').textContent = room.players[playerIndex]?.name || 'æˆ‘';
                            $('oppName').textContent = room.players[1 - playerIndex]?.name || 'å°æ‰‹';
                        }

                        // æ›´æ–°åˆ†æ•¸
                        const me = room.players[playerIndex];
                        const opp = room.players[1 - playerIndex];
                        $('myScore').textContent = me?.score || 0;
                        $('oppScore').textContent = opp?.score || 0;
                        $('myStatus').textContent = me?.answered ? 'âœ“' : '';
                        $('oppStatus').textContent = opp?.answered ? 'âœ“' : '';

                        // è¼‰å…¥é¡Œç›®
                        const myChallenge = room.battleMode === 'solo' 
                            ? room.players[playerIndex]?.challenge 
                            : room.challenge;
                        const myRound = room.battleMode === 'solo'
                            ? (room.players[playerIndex]?.round || 0)
                            : room.round;
                            
                        if (myChallenge && myRound !== currentRound) {
                            currentRound = myRound;
                            clearAnswer();
                            targetColorKey = myChallenge.colorKey;
                            targetPattern = myChallenge.pattern;
                            $('targetFill').style.background = myChallenge.color || COLORS[targetColorKey];
                            $('targetPattern').className = 'pattern-layer active ' + targetPattern;
                            
                            if (room.battleMode === 'solo') {
                                $('hintMessage').textContent = `ç¬¬ ${myRound}/${room.totalRounds} é¡Œ`;
                            } else {
                                $('hintMessage').textContent = `ç¬¬ ${room.round}/${room.totalRounds} é¡Œ - å¿«æ¶ç­”ï¼`;
                            }
                        }
                    } else if (room.status === 'finished') {
                        clearInterval(pollInterval);
                        const isWinner = room.winner === room.players[playerIndex]?.name;
                        showGameEnd(
                            isWinner ? 'ğŸ†' : 'ğŸ˜¢',
                            isWinner ? 'ä½ è´äº†ï¼' : 'å†æ¥å†å²ï¼',
                            `ç²å‹è€…ï¼š${room.winner}`
                        );
                    }
                } catch (e) {}
            }, 500);
        }

        // é›™äººæ¨¡å¼ç­”é¡Œ
        const originalCheckAnswer = checkAnswer;
        checkAnswer = async function() {
            if (gameMode !== 'multi') {
                originalCheckAnswer();
                return;
            }

            if (selectedColors.size === 0) {
                $('hintMessage').textContent = 'ğŸ‘† å…ˆé¸æ“‡é¡è‰²é€æ˜ç‰‡ï¼';
                return;
            }

            const answerKey = [...selectedColors].sort().join('+');

            try {
                const res = await fetch(`/api/game/answer/${roomCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId, colorKey: answerKey, pattern: selectedPattern })
                }).then(r => r.json());

                if (res.error) return;

                if (res.correct) {
                    playSuccess();
                    triggerMammothReaction(true);
                    showResult(true, 'ğŸ‰ æ­£ç¢ºï¼', `${(res.timeUsed / 1000).toFixed(1)} ç§’`);
                } else {
                    playWrong();
                    triggerMammothReaction(false);
                    showResult(false, 'ğŸ¤” å†è©¦è©¦ï¼');
                }

                // æ¸…é™¤é¸æ“‡ä¸¦è¼‰å…¥æ–°é¡Œç›®ï¼ˆsolo æ¨¡å¼ï¼‰
                setTimeout(() => {
                    clearAnswer();
                    // solo æ¨¡å¼ï¼šç›´æ¥ç”¨è¿”å›çš„æ–°é¡Œç›®
                    if (res.newChallenge) {
                        targetColorKey = res.newChallenge.colorKey;
                        targetPattern = res.newChallenge.pattern;
                        $('targetFill').style.background = res.newChallenge.color || COLORS[targetColorKey];
                        $('targetPattern').className = 'pattern-layer active ' + targetPattern;
                        $('hintMessage').textContent = `ç¬¬ ${res.playerRound}/${res.totalRounds} é¡Œ`;
                    }
                }, 1500);
            } catch (e) {}
        };

        // ==================== åˆå§‹åŒ– ====================
        // é–‹å ´å‹•ç•«
        setTimeout(() => {
            showMammothSpeech('startSpeech', 'start');
        }, 800);
    </script>
</body>
</html>
